<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ✅ CSRF 토큰 추가 -->
    <meta name="_csrf" th:content="${_csrf.token}"/>  
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/> 
    
    <title>유저 리스트</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center">
            <h2>유저 리스트</h2>
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="btn btn-secondary">로그아웃</button>
            </form>
        </div>
        
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>아이디</th>
                    <th>이메일</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Loop through the user list -->
                <th:block th:each="user : ${UserlistDTO}">
                    <tr>
                        <td th:text="${user.username}"></td>
                        <td th:text="${user.email}"></td>
                        <td>
                            <!-- 수정 버튼(GET요청) -->
                            <a th:href="@{/userlist/{id}(id=${user.id})}" class="btn btn-warning btn-sm">수정</a>
                            <!-- 삭제 버튼(DELETE요청)-->
                            <button type="button" class="btn btn-danger btn-sm" th:onclick="|deleteUser(${user.id})|">삭제</button>
                        </td>
                    </tr>
                </th:block>
            </tbody>
        </table>
        <a href="/register" class="btn btn-primary">유저 등록</a>
    </div>

    <script>
        // ✅ CSRF 토큰을 가져오는 함수
        function getCsrfToken() {
            return document.querySelector('meta[name="_csrf"]').content;
        }

        function getCsrfHeader() {
            return document.querySelector('meta[name="_csrf_header"]').content;
        }

        // ✅ DELETE 요청을 보내는 함수
        function deleteUser(userId) {
            if (confirm("정말로 이 유저를 삭제하시겠습니까?")) {
                const csrfToken = getCsrfToken();
                const csrfHeader = getCsrfHeader();

                console.log("CSRF Token:", csrfToken);   // ✅ 콘솔에서 CSRF 토큰 확인
                console.log("CSRF Header:", csrfHeader); // ✅ 콘솔에서 CSRF 헤더 확인

                fetch(`/userlist/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken,  // ✅ CSRF 토큰 추가
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        alert('유저가 삭제되었습니다.');
                        window.location.reload();
                    } else {
                        return response.text().then(text => { throw new Error(text) });
                    }
                })
                .catch(error => {
                    console.error("삭제 요청 오류:", error);
                    alert('삭제 중 오류가 발생했습니다.');
                });
            }
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
</body>
</html>
