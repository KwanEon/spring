<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <title>ê²Œì‹œê¸€ ë³´ê¸°</title>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 700px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #333;
        }
        .content {
            margin-top: 20px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .meta {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }
        .buttons {
            margin-top: 30px;
        }
        .buttons a, .buttons button {
            margin-right: 10px;
        }
        .button {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
        }
        .edit-btn {
            background-color: #ffc107;
            color: #333;
            border: 1px solid #e0a800;
        }
        .edit-btn:hover {
            background-color: #e0a800;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: 1px solid #c82333;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        a.back-link {
            margin-left: 10px;
            font-size: 14px;
            color: #333;
            text-decoration: none;
        }
        a.back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<h1 th:text="${post.title}">ì œëª©</h1>

<div class="meta">
    ì‘ì„±ì: <span th:text="${post.author}">ì‘ì„±ì</span> |
    ì‘ì„±ì¼: <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</span> |
    ì¡°íšŒìˆ˜: <span th:text="${post.views}">ì¡°íšŒìˆ˜</span>
</div>

<div class="content" th:text="${post.content}">ë‚´ìš©</div>

<div th:if="${post.attachments != null and post.attachments.size() > 0}">
    <h3>ì²¨ë¶€íŒŒì¼</h3>
    <ul>
        <li th:each="attachment : ${post.attachments}">
            <a th:href="@{'/download?no=' + ${attachment.id}}" th:text="${attachment.originalName}">ì²¨ë¶€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a>
        </li>
    </ul>
</div>

<div class="buttons">
    <th:block th:if="${#authentication?.principal != null and post.author == #authentication.principal.username or #authentication?.principal?.username == 'admin'}">
        <a th:href="@{'/postlist/edit/' + ${post.id}}" class="button edit-btn">âœ ìˆ˜ì •</a>
        <form th:action="@{'/postlist/' + ${post.id}}" method="post"
              onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" style="display:inline;">
            <input type="hidden" name="_method" value="delete"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="button delete-btn">ğŸ—‘ ì‚­ì œ</button>
        </form>
    </th:block>
    <a th:href="@{/postlist}" class="back-link">â† ëª©ë¡ìœ¼ë¡œ</a>
</div>

<h3>ëŒ“ê¸€</h3>
<ul>
    <li th:each="comment : ${comments}" th:id="'comment-' + ${comment.id}">
        <strong th:text="${comment.author}">ì‘ì„±ì</strong>:
        <span th:text="${comment.content}" th:id="'content-' + ${comment.id}">ë‚´ìš©</span>
        <em th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</em>

        <th:block th:if="${#authentication?.principal?.username == comment.author or #authentication?.principal?.username == 'admin'}">
            <button type="button"
                    class="edit-button"
                    th:data-id="${comment.id}"
                    th:data-content="${comment.content}">
                âœ ìˆ˜ì •
            </button>

            <form th:action="@{'/postlist/' + ${post.id} + '/comment/' + ${comment.id}}" method="post"
                  style="display:inline;"
                  onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                <input type="hidden" name="_method" value="delete"/>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit">ğŸ—‘ ì‚­ì œ</button>
            </form>
        </th:block>
    </li>
</ul>

<!-- ìˆ˜ì • í¼ ì˜ì—­ -->
<div id="edit-comment-form" style="display:none; margin-top: 10px;">
    <form method="post" id="editForm">
        <textarea name="content" id="editContent" rows="3" cols="60" required></textarea><br>
        <button type="submit">ğŸ’¾ ì €ì¥</button>
        <button type="button" onclick="cancelEdit()">âŒ ì·¨ì†Œ</button>
    </form>
</div>

<!-- ëŒ“ê¸€ ì‘ì„± -->
<form th:action="@{'/postlist/' + ${post.id} + '/comment'}" method="post" th:object="${commentDTO}">
    <textarea th:field="*{content}" rows="3" cols="60" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
    <br>
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
</form>

<script th:inline="javascript">
    const postId = "[[${post.id}]]";

    function showEditForm(commentId, content) {
        const formDiv = document.getElementById("edit-comment-form");
        const form = document.getElementById("editForm");
        const textarea = document.getElementById("editContent");

        textarea.value = content;
        form.action = `/postlist/${postId}/comment/${commentId}`;
        form.method = "post";

        // CSRF í† í° ì²˜ë¦¬
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const csrfInput = document.createElement("input");
        csrfInput.type = "hidden";
        csrfInput.name = "_csrf";
        csrfInput.value = csrfToken;

        // ê¸°ì¡´ í† í° ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€
        const oldToken = form.querySelector('input[name="_csrf"]');
        if (oldToken) oldToken.remove();
        form.appendChild(csrfInput);

        formDiv.style.display = "block";

        const commentElement = document.getElementById("comment-" + commentId);
        commentElement.appendChild(formDiv);
    }

    function cancelEdit() {
        document.getElementById("edit-comment-form").style.display = "none";
    }

    document.querySelectorAll('.edit-button').forEach(btn => {
        btn.addEventListener('click', () => {
            const commentId = btn.dataset.id;
            const content = btn.dataset.content;
            showEditForm(commentId, content);
        });
    });
</script>
</body>
</html>
